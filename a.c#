// xxe.cs
using System;
using System.Data;
using System.IO;
using System.Xml;
using System.Xml.Linq;
using System.Xml.XPath;
using System.Xml.Serialization;
using Microsoft.Extensions.Logging;

public class XXEExamples
{
    private readonly ILogger _logger;
    public XXEExamples(ILogger logger) => _logger = logger;

    // 0) XmlDocument: external entity resolution enabled (bad)
    private void ProcessXmlWithXxeVulnerability(string xmlContent0)
    {
        try
        {
            // ruleid: xmldocument-external-entity-resolution-enabled
            var xmlDoc = new XmlDocument();
            xmlDoc.XmlResolver = new XmlUrlResolver();
            xmlDoc.LoadXml(xmlContent0);
            _logger.LogInformation($"XML processed: {xmlDoc.InnerXml}");
        }
        catch (Exception ex)
        {
            _logger.LogError($"Error processing XML: {ex.Message}");
        }
    }

    // 1) XmlDocument: initializer sets resolver (bad)
    public void DocWithInitializer(string payload1)
    {
        // ruleid: xmldocument-external-entity-resolution-enabled
        var doc = new XmlDocument { XmlResolver = new XmlUrlResolver() };
        doc.LoadXml(payload1);
    }

    // 2) XmlReaderSettings: assignments enable DTD + resolver (bad)
    public void ReaderWithAssignments(string payload2)
    {
        // ruleid: xmlreadersettings-xxe-enabled
        var settings = new XmlReaderSettings();
        settings.DtdProcessing = DtdProcessing.Parse;
        settings.XmlResolver = new XmlUrlResolver();
        // ruleid: xmlreader-created-with-unsafe-settings
        var rdr2 = XmlReader.Create(new StringReader(payload2), settings);
        var doc2 = new XmlDocument();
        doc2.Load(rdr2);
    }

    // 3) XmlReaderSettings: initializer enables DTD + resolver (bad)
    public void ReaderWithInitializer(string payload3)
    {
        // ruleid: xmlreadersettings-xxe-enabled
        var settings3 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Parse,
            XmlResolver = new XmlUrlResolver()
        };
        // ruleid: xmlreader-created-with-unsafe-settings
        var rdr3 = XmlReader.Create(new StringReader(payload3), settings3);
        var xdoc3 = XDocument.Load(rdr3);
    }

    // 4) Legacy XmlTextReader configured unsafely (bad)
    public void LegacyTextReader(string payload4)
    {
        // ruleid: xmltextreader-unsafe-xxe-configuration
        var xr4 = new XmlTextReader(new StringReader(payload4));
        xr4.DtdProcessing = DtdProcessing.Parse;
        xr4.XmlResolver = new XmlUrlResolver();
        var doc4 = new XmlDocument();
        doc4.Load(xr4);
    }

    // 5) XPathDocument using reader from unsafe settings (bad)
    public void XPathDocWithReader(string payload5)
    {
        // ruleid: xmlreadersettings-xxe-enabled
        var settings5 = new XmlReaderSettings { DtdProcessing = DtdProcessing.Parse, XmlResolver = new XmlUrlResolver() };
        // ruleid: xmlreader-created-with-unsafe-settings
        using var reader5 = XmlReader.Create(new StringReader(payload5), settings5);
        var xp5 = new XPathDocument(reader5);
    }

    // 6) XmlSerializer using reader from unsafe settings (bad)
    public object DeserializeWithReader(string payload6, Type targetType6)
    {
        // ruleid: xmlreadersettings-xxe-enabled
        var settings6 = new XmlReaderSettings { DtdProcessing = DtdProcessing.Parse, XmlResolver = new XmlUrlResolver() };
        // ruleid: xmlreader-created-with-unsafe-settings
        using var reader6 = XmlReader.Create(new StringReader(payload6), settings6);
        var ser6 = new XmlSerializer(targetType6);
        return ser6.Deserialize(reader6);
    }

    // 7) DataSet.ReadXml using reader from unsafe settings (bad)
    public void DataSetReadXml(string payload7)
    {
        // ruleid: xmlreadersettings-xxe-enabled
        var settings7 = new XmlReaderSettings { DtdProcessing = DtdProcessing.Parse, XmlResolver = new XmlUrlResolver() };
        // ruleid: xmlreader-created-with-unsafe-settings
        using var reader7 = XmlReader.Create(new StringReader(payload7), settings7);
        var ds7 = new DataSet();
        ds7.ReadXml(reader7);
    }

    // 8) Safe: XmlDocument via safe reader (good)
    public void SafeExample(string xmlSafe1)
    {
        var safeSettings1 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader1 = XmlReader.Create(new StringReader(xmlSafe1), safeSettings1); // ok: xmlreader-created-with-unsafe-settings
        var safeDoc1 = new XmlDocument();
        safeDoc1.Load(safeReader1);
    }

    // 9) Safe: XDocument with safe reader (good)
    public void SafeXDocument(string xmlSafe2)
    {
        var safeSettings2 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader2 = XmlReader.Create(new StringReader(xmlSafe2), safeSettings2); // ok: xmlreader-created-with-unsafe-settings
        var xdocSafe2 = XDocument.Load(safeReader2);
    }

    // 10) Safe: XPathDocument with safe reader (good)
    public void SafeXPathDocument(string xmlSafe3)
    {
        var safeSettings3 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Ignore,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader3 = XmlReader.Create(new StringReader(xmlSafe3), safeSettings3); // ok: xmlreader-created-with-unsafe-settings
        var xpSafe3 = new XPathDocument(safeReader3);
    }

    // 11) Safe: XmlSerializer with safe reader (good)
    public object SafeDeserialize(string xmlSafe4, Type targetTypeSafe4)
    {
        var safeSettings4 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader4 = XmlReader.Create(new StringReader(xmlSafe4), safeSettings4); // ok: xmlreader-created-with-unsafe-settings
        var serSafe4 = new XmlSerializer(targetTypeSafe4);
        return serSafe4.Deserialize(safeReader4);
    }

    // 12) Safe: DataSet.ReadXml with safe reader (good)
    public void SafeDataSetRead(string xmlSafe5)
    {
        var safeSettings5 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader5 = XmlReader.Create(new StringReader(xmlSafe5), safeSettings5); // ok: xmlreader-created-with-unsafe-settings
        var dsSafe5 = new DataSet();
        dsSafe5.ReadXml(safeReader5);
    }

    // 13) Safe: XmlDocument explicit null resolver + safe reader (good)
    public void SafeXmlDocumentExplicit(string xmlSafe6)
    {
        var safeSettings6 = new XmlReaderSettings
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmlreadersettings-xxe-enabled
        using var safeReader6 = XmlReader.Create(new StringReader(xmlSafe6), safeSettings6); // ok: xmlreader-created-with-unsafe-settings
        var docSafe6 = new XmlDocument { XmlResolver = null }; // ok: xmldocument-external-entity-resolution-enabled
        docSafe6.Load(safeReader6);
    }

    // 14) Safe: Legacy XmlTextReader locked down (good)
    public void SafeLegacyXmlTextReader(string xmlSafe7)
    {
        var xrSafe7 = new XmlTextReader(new StringReader(xmlSafe7))
        {
            DtdProcessing = DtdProcessing.Prohibit,
            XmlResolver = null
        }; // ok: xmltextreader-unsafe-xxe-configuration
        var docSafe7 = new XmlDocument();
        docSafe7.Load(xrSafe7);
    }
}
